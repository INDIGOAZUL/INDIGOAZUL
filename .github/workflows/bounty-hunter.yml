name: ðŸŽ¯ Bounty Hunter - Find Paid Opportunities

on:
  schedule:
    # Run every 6 hours to search for new bounties
    - cron: '0 */6 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  search-github-bounties:
    name: Search GitHub for Paid Bounties
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Search for bounties across GitHub
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          console.log('ðŸ” Searching for paid bounties across GitHub...');

          // Search queries for different bounty platforms and patterns
          const searchQueries = [
            'label:bounty is:open is:issue',
            'label:"ðŸ’° bounty" is:open is:issue',
            'label:gitcoin is:open is:issue',
            '"$" AND "bounty" is:open is:issue',
            '"USD" AND "bounty" is:open is:issue',
            'label:good-first-issue label:bounty is:open',
            '"cash reward" is:open is:issue'
          ];

          const foundBounties = [];
          const today = new Date();
          const sevenDaysAgo = new Date(today - 7 * 24 * 60 * 60 * 1000);

          for (const query of searchQueries) {
            try {
              console.log(`Searching: ${query}`);

              const { data: issues } = await github.rest.search.issuesAndPullRequests({
                q: query,
                sort: 'created',
                order: 'desc',
                per_page: 20
              });

              // Verified repos with confirmed bounty programs
              const verifiedRepos = [
                // Expensify - Official bug bounty program ($50-$10,000+)
                'Expensify/App',

                // Ethereum/Web3 with known bounty programs
                'XDC-Community/XDPoSChain',
                'ethereum/go-ethereum',
                'ethereum/solidity',
                'OpenZeppelin/openzeppelin-contracts',
                'OpenZeppelin/openzeppelin-upgrades',

                // DeFi protocols with bug bounties
                'Uniswap/v3-core',
                'Uniswap/v2-core',
                'aave/aave-v3-core',
                'compound-finance/compound-protocol',

                // Other verified programs
                'gitcoinco/web',
                'nodejs/node',
                'microsoft/vscode',
                'facebook/react',
                'vercel/next.js'
              ];

              // Bug bounty platforms (auto-verified)
              const bountyPlatforms = [
                'gitcoinco/',
                'IssueHunt/',
                'Bountysource/'
              ];

              for (const issue of issues.items) {
                // Skip if already in our list
                if (foundBounties.find(b => b.url === issue.html_url)) continue;

                // FILTER 1: Skip if already assigned
                if (issue.assignees && issue.assignees.length > 0) {
                  continue;
                }

                // Analyze issue body for payment indicators
                const body = (issue.body || '').toLowerCase();
                const title = issue.title.toLowerCase();
                const combined = `${title} ${body}`;
                const repo = issue.repository_url.split('/').slice(-2).join('/');

                // FILTER 2: Skip false positives (budgets, documentation)
                const falsePositiveKeywords = [
                  'budget breakdown',
                  'phase-by-phase budget',
                  'total project budget',
                  'funding structure',
                  'development budget',
                  'rate table',
                  'budget summary',
                  'cost estimate'
                ];

                const isFalsePositive = falsePositiveKeywords.some(keyword => combined.includes(keyword));
                if (isFalsePositive) {
                  continue;
                }

                // FILTER 3: Must be short enough to be a bounty (not documentation)
                if (body.length > 5000) {
                  continue;
                }

                // Look for money indicators
                const hasMoneyIndicator =
                  combined.includes('$') ||
                  combined.includes('usd') ||
                  combined.includes('paid') ||
                  combined.includes('reward') ||
                  combined.includes('gitcoin') ||
                  combined.includes('bounty') ||
                  combined.includes('eth') ||
                  combined.includes('btc');

                if (hasMoneyIndicator) {
                  // Extract potential amount - improved pattern
                  const patterns = [
                    /\$(\d+)(?!\s*\/hr)/i,  // $250 but not $90/hr
                    /(\d+)\s*usd/i,          // 250 USD
                    /bounty:\s*\$(\d+)/i,    // Bounty: $250
                    /reward:\s*\$(\d+)/i     // Reward: $250
                  ];

                  let amount = null;
                  for (const pattern of patterns) {
                    const match = combined.match(pattern);
                    if (match) {
                      amount = parseInt(match[1]);
                      if (amount < 30) continue; // Skip hourly rates
                      break;
                    }
                  }

                  // FILTER 4: Must have valid bounty amount
                  if (!amount || amount < 20) {
                    continue;
                  }

                  // FILTER 5: Verify repo has official bounty program
                  const isVerifiedRepo = verifiedRepos.includes(repo);
                  const isBountyPlatform = bountyPlatforms.some(platform => repo.startsWith(platform));

                  // If NOT verified, apply strict checks
                  if (!isVerifiedRepo && !isBountyPlatform) {
                    // Skip security vulnerability reports (likely rejected)
                    const securityKeywords = [
                      'cvss',
                      'vulnerability',
                      'proof of concept',
                      'security fix',
                      'exploit',
                      'rejected',
                      'invalid claim',
                      'out of scope'
                    ];

                    const isSecurityReport = securityKeywords.some(keyword => combined.includes(keyword));
                    if (isSecurityReport) {
                      console.log(`   âš ï¸ Skipping security report in unverified repo: ${repo}`);
                      continue;
                    }

                    // For unverified repos, require explicit bounty labels
                    const hasBountyLabel = issue.labels.some(l =>
                      l.name.toLowerCase().includes('bounty') ||
                      l.name.toLowerCase().includes('gitcoin') ||
                      l.name.toLowerCase().includes('reward')
                    );

                    if (!hasBountyLabel) {
                      console.log(`   âš ï¸ Skipping unverified repo without bounty label: ${repo}`);
                      continue;
                    }
                  }

                  // Score the bounty
                  let score = 0;

                  // Amount scoring
                  if (amount >= 500) score += 4;
                  else if (amount >= 200) score += 3;
                  else if (amount >= 100) score += 2;
                  else if (amount >= 50) score += 1;

                  // Verified repo bonus (MAJOR BOOST)
                  if (isVerifiedRepo) score += 5;
                  if (isBountyPlatform) score += 4;

                  // Labels
                  if (issue.labels.some(l => l.name.toLowerCase().includes('good first issue'))) score += 2;
                  if (issue.labels.some(l => l.name.toLowerCase().includes('help wanted'))) score += 1;
                  if (issue.labels.some(l => l.name.toLowerCase().includes('external'))) score += 1;

                  // Competition
                  if (issue.comments === 0) score += 2;
                  else if (issue.comments < 3) score += 1;

                  // Freshness
                  if (new Date(issue.created_at) > sevenDaysAgo) score += 1;

                  // Tech stack
                  const preferredTech = ['javascript', 'typescript', 'react', 'node', 'web3', 'solidity', 'ethereum', 'polygon'];
                  const hasTech = preferredTech.some(tech => combined.includes(tech));
                  if (hasTech) score += 2;

                  foundBounties.push({
                    title: issue.title,
                    url: issue.html_url,
                    repo: repo,
                    amount: amount,
                    labels: issue.labels.map(l => l.name),
                    created: issue.created_at,
                    comments: issue.comments,
                    assignees: 0,
                    score: score,
                    body_preview: body.substring(0, 200),
                    verified_repo: isVerifiedRepo,
                    bounty_platform: isBountyPlatform,
                    trust_level: isVerifiedRepo ? 'HIGH' : (isBountyPlatform ? 'MEDIUM' : 'LOW')
                  });
                }
              }
            } catch (error) {
              console.log(`Error searching "${query}":`, error.message);
            }
          }

          // Sort by score (best opportunities first)
          foundBounties.sort((a, b) => b.score - a.score);

          console.log(`\nâœ… Found ${foundBounties.length} potential bounties`);

          // Calculate trust statistics
          const trustStats = {
            high: foundBounties.filter(b => b.trust_level === 'HIGH').length,
            medium: foundBounties.filter(b => b.trust_level === 'MEDIUM').length,
            low: foundBounties.filter(b => b.trust_level === 'LOW').length
          };

          // Save to file
          const timestamp = new Date().toISOString();
          const report = {
            generated_at: timestamp,
            total_found: foundBounties.length,
            trust_stats: trustStats,
            bounties: foundBounties.slice(0, 50) // Top 50
          };

          fs.writeFileSync('bounty-opportunities.json', JSON.stringify(report, null, 2));

          // Create summary
          let summary = `## ðŸŽ¯ Bounty Hunter Report\n\n`;
          summary += `**Generated:** ${timestamp}\n`;
          summary += `**Total Found:** ${foundBounties.length}\n\n`;
          summary += `### ðŸ”’ Trust Level Breakdown\n`;
          summary += `- âœ… **HIGH** (Verified Repos): ${trustStats.high}\n`;
          summary += `- âš ï¸ **MEDIUM** (Bounty Platforms): ${trustStats.medium}\n`;
          summary += `- âš¡ **LOW** (Other): ${trustStats.low}\n\n`;
          summary += `### ðŸ† Top 10 Opportunities\n\n`;

          foundBounties.slice(0, 10).forEach((bounty, index) => {
            const trustIcon = bounty.trust_level === 'HIGH' ? 'âœ…' : (bounty.trust_level === 'MEDIUM' ? 'âš ï¸' : 'âš¡');
            summary += `**${index + 1}. ${bounty.title}** ${trustIcon}\n`;
            summary += `   - ðŸ’° Amount: ${bounty.amount === 'Unknown' ? 'Not specified' : '$' + bounty.amount}\n`;
            summary += `   - ðŸ“¦ Repo: ${bounty.repo}\n`;
            summary += `   - ðŸ”’ Trust: ${bounty.trust_level}${bounty.verified_repo ? ' (VERIFIED PROGRAM)' : ''}\n`;
            summary += `   - ðŸ·ï¸ Labels: ${bounty.labels.join(', ') || 'none'}\n`;
            summary += `   - ðŸ’¬ Comments: ${bounty.comments}\n`;
            summary += `   - ðŸ‘¥ Assignees: ${bounty.assignees}\n`;
            summary += `   - â­ Score: ${bounty.score}/15\n`;
            summary += `   - ðŸ”— [View Issue](${bounty.url})\n\n`;
          });

          fs.writeFileSync('GITHUB_STEP_SUMMARY.md', summary);
          console.log(summary);

    - name: Commit bounty report
      run: |
        git config user.name "Bounty Hunter Bot"
        git config user.email "bounty-hunter@latanda.online"

        if [ -f bounty-opportunities.json ]; then
          git add bounty-opportunities.json
          git commit -m "ðŸŽ¯ Auto-update: Bounty opportunities $(date +%Y-%m-%d)" || echo "No changes to commit"
          git push || echo "Nothing to push"
        fi

    - name: Create notification summary
      run: |
        echo "## ðŸŽ¯ Bounty Hunter Scan Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -f GITHUB_STEP_SUMMARY.md ]; then
          cat GITHUB_STEP_SUMMARY.md >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "**Next scan:** In 6 hours" >> $GITHUB_STEP_SUMMARY
        echo "**Report saved:** \`bounty-opportunities.json\`" >> $GITHUB_STEP_SUMMARY

  check-bounty-platforms:
    name: Check External Bounty Platforms
    runs-on: ubuntu-latest

    steps:
    - name: Check popular bounty platforms
      run: |
        echo "ðŸ” Checking external bounty platforms..."

        echo "## ðŸ’° External Bounty Platforms to Check" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Visit these platforms manually for paid opportunities:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "1. **Gitcoin** - https://gitcoin.co/explorer" >> $GITHUB_STEP_SUMMARY
        echo "   - Web3 and blockchain bounties" >> $GITHUB_STEP_SUMMARY
        echo "   - Typical range: \$100-\$5,000" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "2. **Bountysource** - https://www.bountysource.com/" >> $GITHUB_STEP_SUMMARY
        echo "   - Open source bounties" >> $GITHUB_STEP_SUMMARY
        echo "   - Typical range: \$50-\$1,000" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "3. **IssueHunt** - https://issuehunt.io/" >> $GITHUB_STEP_SUMMARY
        echo "   - GitHub issue bounties" >> $GITHUB_STEP_SUMMARY
        echo "   - Typical range: \$20-\$500" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "4. **HackerOne** - https://www.hackerone.com/opportunities" >> $GITHUB_STEP_SUMMARY
        echo "   - Security bug bounties" >> $GITHUB_STEP_SUMMARY
        echo "   - Typical range: \$100-\$10,000+" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "5. **Layer3** - https://layer3.xyz/quests" >> $GITHUB_STEP_SUMMARY
        echo "   - Web3 bounties and quests" >> $GITHUB_STEP_SUMMARY
        echo "   - Typical range: \$50-\$1,000" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "6. **Replit Bounties** - https://replit.com/bounties" >> $GITHUB_STEP_SUMMARY
        echo "   - Coding challenges" >> $GITHUB_STEP_SUMMARY
        echo "   - Typical range: \$100-\$2,000" >> $GITHUB_STEP_SUMMARY
